# Copyright (c) 2013 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# The dev-install package used to install into /etc/portage/ that older portage
# would ignore, but newer one uses (and fails).  So force all boards to install
# the latest version.

opkg="chromeos-base/dev-install"
ver="0.0.1-r427"

export CLEAN_DELAY=0

update() {
  local root=$1 board=$2 emerge

  if [[ -z ${board} ]]; then
    board="root"
    emerge="sudo -E emerge"
  else
    emerge="emerge-${board}"
  fi

  if portageq has_version ${root} "<${opkg}-${ver}"; then
    ${emerge} -1ug ">=${opkg}-${ver}"
  fi
}

update / &

for board_root in /build/*; do
  board=${board_root##*/}
  update ${board_root} ${board} &
done

wait
